export const metadata = {
  title: 'API Reference',
  description: 'Complete API reference for AICodeRally applications'
}

# API Reference

Complete reference for all API endpoints in the AICodeRally platform.

> **üìù Note:** This reference is based on actual API routes in the codebase. All routes follow Next.js App Router conventions.

---

## Base URLs

**Development:**
- Studio: `http://localhost:3000/api`
- Edge: `http://localhost:3001/api`
- Summit: `http://localhost:3002/api`

**Production:**
- Studio: `https://studio.aicoderally.com/api`
- Edge: `https://edge.aicoderally.com/api`
- Summit: `https://summit.aicoderally.com/api`

---

## Authentication

All API routes use **NextAuth v5** for authentication. Include session cookies with requests.

### Getting a Session

```typescript
import { auth } from "@/auth";

export async function GET(req: Request) {
  const session = await auth();

  if (!session) {
    return new Response("Unauthorized", { status: 401 });
  }

  // Use session.user
}
```

---

## Studio App APIs

### AI Features

#### POST `/api/ai/chat`

AI chat endpoint for conversational interactions.

**Request:**
```typescript
{
  message: string;
  context?: string;
}
```

**Response:**
```typescript
{
  reply: string;
  usage?: {
    tokens: number;
  }
}
```

**Example:**
```typescript
const res = await fetch('/api/ai/chat', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    message: "How do I implement authentication?",
    context: "NextAuth v5 with OAuth"
  })
});

const data = await res.json();
console.log(data.reply);
```

---

#### POST `/api/ai/generate-business-models`

Generate business model suggestions using AI.

**Request:**
```typescript
{
  industry: string;
  targetAudience: string;
  problem: string;
}
```

**Response:**
```typescript
{
  models: Array<{
    name: string;
    description: string;
    revenue: string;
    marketSize: string;
  }>;
}
```

---

#### POST `/api/ai/generate-roadmap`

Generate product roadmap using AI.

**Request:**
```typescript
{
  product: string;
  goals: string[];
  timeline: string;
}
```

**Response:**
```typescript
{
  roadmap: {
    phases: Array<{
      name: string;
      duration: string;
      milestones: string[];
    }>;
  }
}
```

---

#### POST `/api/ai/compile-module`

Compile module specifications into implementation plan.

**Request:**
```typescript
{
  moduleName: string;
  requirements: string;
}
```

**Response:**
```typescript
{
  implementation: {
    files: string[];
    dependencies: string[];
    steps: string[];
  }
}
```

---

#### POST `/api/ai/generate-thesis`

Generate technical thesis for a feature.

**Request:**
```typescript
{
  feature: string;
  context: string;
}
```

**Response:**
```typescript
{
  thesis: string;
  assumptions: string[];
  risks: string[];
}
```

---

### Pit Wall (Collaboration)

#### GET `/api/pit-wall/threads/[moduleId]`

Get discussion threads for a module.

**Parameters:**
- `moduleId` - Module identifier

**Response:**
```typescript
{
  threads: Array<{
    id: string;
    title: string;
    moduleId: string;
    createdAt: string;
    commentCount: number;
  }>;
}
```

---

#### POST `/api/pit-wall/threads/[moduleId]`

Create a new thread for a module.

**Request:**
```typescript
{
  title: string;
  initialComment: string;
}
```

**Response:**
```typescript
{
  thread: {
    id: string;
    title: string;
    moduleId: string;
    createdAt: string;
  }
}
```

---

#### GET `/api/pit-wall/threads/[moduleId]/comments`

Get comments for a thread.

**Response:**
```typescript
{
  comments: Array<{
    id: string;
    body: string;
    author: string;
    createdAt: string;
    reactions: Array<{
      emoji: string;
      count: number;
    }>;
  }>;
}
```

---

#### POST `/api/pit-wall/threads/[moduleId]/comments`

Add a comment to a thread.

**Request:**
```typescript
{
  body: string;
  parentId?: string; // For replies
}
```

**Response:**
```typescript
{
  comment: {
    id: string;
    body: string;
    author: string;
    createdAt: string;
  }
}
```

---

#### POST `/api/pit-wall/comments/[commentId]/reactions`

Add a reaction to a comment.

**Request:**
```typescript
{
  emoji: string;
}
```

**Response:**
```typescript
{
  reaction: {
    id: string;
    emoji: string;
    userEmail: string;
  }
}
```

---

#### DELETE `/api/pit-wall/comments/[commentId]/reactions`

Remove a reaction from a comment.

**Request:**
```typescript
{
  emoji: string;
}
```

**Response:**
```typescript
{
  success: boolean;
}
```

---

#### GET `/api/pit-wall/stakeholders/[moduleId]`

Get stakeholders for a module.

**Response:**
```typescript
{
  stakeholders: Array<{
    id: string;
    email: string;
    role: string;
    permissions: string[];
  }>;
}
```

---

#### POST `/api/pit-wall/stakeholders/[moduleId]`

Add a stakeholder to a module.

**Request:**
```typescript
{
  email: string;
  role: string;
  permissions: string[];
}
```

---

#### POST `/api/pit-wall/attachments`

Upload an attachment.

**Request:** Multipart form data with file

**Response:**
```typescript
{
  attachment: {
    id: string;
    url: string;
    filename: string;
    size: number;
  }
}
```

---

### AI Memory Management

#### GET `/api/ai-memory`

List all AI memory files.

**Response:**
```typescript
{
  files: Array<{
    filename: string;
    size: number;
    lastModified: string;
  }>;
}
```

---

#### GET `/api/ai-memory/[filename]`

Get contents of a specific memory file.

**Parameters:**
- `filename` - Memory file name

**Response:**
```typescript
{
  filename: string;
  content: string;
}
```

---

#### POST `/api/ai-memory/[filename]`

Update or create a memory file.

**Request:**
```typescript
{
  content: string;
}
```

---

### Consensus Engine

#### POST `/api/consensus`

Get consensus recommendation from multiple AI models.

**Request:**
```typescript
{
  question: string;
  options: string[];
  context?: string;
}
```

**Response:**
```typescript
{
  consensus: {
    recommendation: string;
    confidence: number;
    reasoning: string;
    modelResponses: Array<{
      model: string;
      choice: string;
      reasoning: string;
    }>;
  }
}
```

---

### War Room

#### GET `/api/war-room`

Get war room status and active discussions.

**Response:**
```typescript
{
  status: string;
  activeIssues: Array<{
    id: string;
    title: string;
    severity: string;
    participants: string[];
  }>;
}
```

---

## Edge App APIs

### Vendor Management (TacoFinder)

#### GET `/api/vendors`

List all vendors.

**Query Parameters:**
- `search` - Search query
- `category` - Filter by category
- `rating` - Minimum rating

**Response:**
```typescript
{
  vendors: Array<{
    id: string;
    name: string;
    category: string;
    rating: number;
    location: {
      lat: number;
      lng: number;
    };
  }>;
}
```

---

#### GET `/api/vendors/[id]`

Get vendor details.

**Response:**
```typescript
{
  vendor: {
    id: string;
    name: string;
    description: string;
    category: string;
    rating: number;
    reviewCount: number;
    menu: Array<MenuItem>;
    deals: Array<Deal>;
  }
}
```

---

#### GET `/api/vendors/[id]/menu`

Get vendor menu.

**Response:**
```typescript
{
  menu: Array<{
    id: string;
    name: string;
    description: string;
    price: number;
    category: string;
    image?: string;
  }>;
}
```

---

#### GET `/api/vendors/[id]/reviews`

Get vendor reviews.

**Response:**
```typescript
{
  reviews: Array<{
    id: string;
    rating: number;
    comment: string;
    author: string;
    createdAt: string;
  }>;
}
```

---

#### POST `/api/vendors/[id]/reviews`

Add a review.

**Request:**
```typescript
{
  rating: number;
  comment: string;
}
```

---

#### GET `/api/vendors/[id]/deals`

Get current deals.

**Response:**
```typescript
{
  deals: Array<{
    id: string;
    title: string;
    description: string;
    discount: string;
    validUntil: string;
  }>;
}
```

---

#### POST `/api/vendors/[id]/check-in`

Check in to a vendor location.

**Request:**
```typescript
{
  latitude: number;
  longitude: number;
}
```

**Response:**
```typescript
{
  checkIn: {
    id: string;
    points: number;
    timestamp: string;
  }
}
```

---

### Win The Pick (NFL Predictions)

#### GET `/api/win-the-pick`

Get NFL pick'em game data.

**Response:**
```typescript
{
  week: number;
  games: Array<{
    id: string;
    homeTeam: string;
    awayTeam: string;
    spread: number;
    kickoff: string;
  }>;
}
```

---

#### POST `/api/user-picks`

Submit user picks.

**Request:**
```typescript
{
  week: number;
  picks: Array<{
    gameId: string;
    teamId: string;
  }>;
}
```

---

#### GET `/api/ai-predictions`

Get AI predictions for games.

**Response:**
```typescript
{
  predictions: Array<{
    gameId: string;
    predictedWinner: string;
    confidence: number;
    reasoning: string;
  }>;
}
```

---

#### GET `/api/weekly-recommendations`

Get weekly pick recommendations.

**Response:**
```typescript
{
  recommendations: Array<{
    gameId: string;
    recommendation: string;
    confidence: number;
  }>;
}
```

---

### Authentication (NextAuth)

#### GET/POST `/api/auth/[...nextauth]`

NextAuth authentication endpoints.

**Endpoints:**
- `/api/auth/signin` - Sign in page
- `/api/auth/signout` - Sign out
- `/api/auth/callback/[provider]` - OAuth callbacks
- `/api/auth/session` - Get current session

---

#### POST `/api/auth/signup`

User registration endpoint.

**Request:**
```typescript
{
  email: string;
  password: string;
  name: string;
}
```

---

## Error Responses

All APIs return consistent error responses:

### 400 Bad Request

```typescript
{
  error: "Invalid request",
  details: "Missing required field: email"
}
```

### 401 Unauthorized

```typescript
{
  error: "Unauthorized",
  message: "Please sign in to access this resource"
}
```

### 403 Forbidden

```typescript
{
  error: "Forbidden",
  message: "Insufficient permissions"
}
```

### 404 Not Found

```typescript
{
  error: "Not found",
  resource: "vendor",
  id: "123"
}
```

### 500 Internal Server Error

```typescript
{
  error: "Internal server error",
  message: "An unexpected error occurred"
}
```

---

## Rate Limiting

API endpoints are rate-limited to prevent abuse:

- **Default:** 100 requests per minute per IP
- **AI Endpoints:** 10 requests per minute per user
- **File Uploads:** 20 requests per hour per user

Rate limit headers:
```
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1640000000
```

---

## Pagination

List endpoints support pagination:

**Query Parameters:**
```
?page=1&limit=20
```

**Response:**
```typescript
{
  data: Array<T>;
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
  }
}
```

---

## CORS

**Development:** All origins allowed

**Production:** Only allowed origins:
- `https://aicoderally.com`
- `https://studio.aicoderally.com`
- `https://edge.aicoderally.com`
- `https://summit.aicoderally.com`

---

## Testing APIs

### Using cURL

```bash
# Get vendors
curl http://localhost:3001/api/vendors

# Create a comment
curl -X POST http://localhost:3000/api/pit-wall/threads/module-123/comments \
  -H "Content-Type: application/json" \
  -d '{"body":"Great module!"}'
```

### Using Fetch

```typescript
// With session
const res = await fetch('/api/ai/chat', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  credentials: 'include', // Include session cookies
  body: JSON.stringify({
    message: "Hello AI"
  })
});

const data = await res.json();
```

### Using Postman

1. Import the AICodeRally collection (coming soon)
2. Set environment variables
3. Run requests

---

## WebSocket/Realtime

Realtime features use **Pusher** for live updates:

```typescript
import Pusher from 'pusher-js';

const pusher = new Pusher(process.env.NEXT_PUBLIC_PUSHER_KEY!, {
  cluster: process.env.NEXT_PUBLIC_PUSHER_CLUSTER!,
});

// Subscribe to comments
const channel = pusher.subscribe(`comments-${threadId}`);
channel.bind('new-comment', (data) => {
  console.log('New comment:', data);
});
```

**Channels:**
- `comments-{threadId}` - New comments
- `reactions-{threadId}` - New reactions
- `stakeholders-{moduleId}` - Stakeholder updates

---

## Related Documentation

- [Environment Variables](/deployment/environment-variables) - API authentication setup
- [Getting Started](/getting-started) - Development environment setup
- [AI Gateway Integration](/integration/ai-gateway) - AI API routing
- [Deployment Guide](/deployment) - Production API configuration

---

## Response Status Codes

| Code | Meaning | When to Handle |
|------|---------|-----------------|
| 200 | OK | Request succeeded, data returned |
| 201 | Created | Resource created successfully |
| 204 | No Content | Success with no response body |
| 400 | Bad Request | Invalid parameters or malformed request |
| 401 | Unauthorized | Not authenticated or token expired |
| 403 | Forbidden | Authenticated but lacking permissions |
| 404 | Not Found | Resource doesn't exist |
| 409 | Conflict | Resource already exists or state conflict |
| 422 | Unprocessable | Validation failed on your data |
| 429 | Too Many Requests | Rate limit exceeded, retry after delay |
| 500 | Server Error | Unexpected server error, report if persistent |
| 503 | Service Unavailable | Temporary outage, retry with backoff |

---

## Common Request/Response Patterns

### Success Response (Studio AI API)

```json
{
  "success": true,
  "data": {
    "reply": "Here's my response...",
    "usage": {
      "inputTokens": 245,
      "outputTokens": 892,
      "totalTokens": 1137
    },
    "timestamp": "2025-12-03T15:30:00Z",
    "model": "anthropic/claude-sonnet-4-5"
  }
}
```

### Error Response (Validation Failed)

```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Validation failed",
    "details": {
      "field": "email",
      "issue": "Invalid email format",
      "received": "not-an-email"
    }
  }
}
```

### List Response with Pagination (Vendors)

```json
{
  "success": true,
  "data": [
    {
      "id": "vendor_123",
      "name": "Best Taco Shop",
      "category": "food",
      "rating": 4.8
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 147,
    "totalPages": 8,
    "hasNextPage": true,
    "nextPageUrl": "/api/vendors?page=2&limit=20"
  }
}
```

---

## Webhook Events (Future)

Webhooks allow your app to receive real-time notifications:

```typescript
// Supported events:
event_types = [
  "thread.created",      // New discussion thread
  "comment.posted",      // New comment
  "reaction.added",      // User reacted to comment
  "vendor.updated",      // Vendor info changed
  "ai.request.failed",   // AI request error
  "deployment.completed" // Build completed
]
```

**Register webhook:**
```typescript
POST /api/webhooks
{
  "url": "https://your-app.com/webhook",
  "events": ["comment.posted", "thread.created"],
  "secret": "whsec_your_signing_secret"
}
```

**Webhook payload:**
```json
{
  "id": "evt_123",
  "type": "comment.posted",
  "timestamp": "2025-12-03T15:30:00Z",
  "data": {
    "comment": { ... },
    "thread": { ... }
  },
  "signature": "v1,hash_of_payload"
}
```

**Verify webhook signature:**
```typescript
import { verify } from '@/lib/webhooks';

const body = await req.text();
const signature = req.headers.get('x-signature');

try {
  const event = verify(body, signature, process.env.WEBHOOK_SECRET);
  // Handle event
} catch (error) {
  return Response.json({ error: 'Invalid signature' }, { status: 401 });
}
```

---

## SDK Support

**Official TypeScript/JavaScript SDK** (Recommended):

```bash
npm install @rally/sdk
# or
pnpm add @rally/sdk
```

```typescript
import { RallyClient } from '@rally/sdk';

const client = new RallyClient({
  apiKey: process.env.RALLY_API_KEY,
  baseURL: 'https://api.aicoderally.com',
});

// Use TypeScript types automatically
const vendors = await client.vendors.list({ category: 'food' });
const response = await client.ai.chat({ message: 'Hello!' });
```

**Other SDKs coming soon:**
- Python (`pip install rally-sdk`)
- Go (`go get github.com/aicoderally/sdk-go`)
- Ruby, PHP, Java

**For now, use:**
- Direct HTTP requests (any language)
- Vercel AI SDK for AI features
- Postman for exploration

---

## API Versioning

All APIs are versioned in the URL:

**Current version:** `v1` (default)

```
https://api.aicoderally.com/v1/vendors
```

**Version support:**
- `v1` - Current, fully supported
- Deprecated versions notified 6 months in advance

**Staying compatible:**
- Use specific version in requests
- Subscribe to API change notifications
- Monitor deprecation warnings in response headers

---

## Best Practices

### 1. Error Handling

```typescript
async function makeRequest(url: string, options: RequestInit) {
  try {
    const res = await fetch(url, options);

    if (!res.ok) {
      const error = await res.json();
      throw new Error(`${res.status}: ${error.message}`);
    }

    return await res.json();
  } catch (error) {
    console.error('API error:', error);
    // Retry with exponential backoff
    // Or surface user-friendly message
  }
}
```

### 2. Pagination

```typescript
async function getAllVendors() {
  let allVendors = [];
  let page = 1;
  let hasMore = true;

  while (hasMore) {
    const res = await fetch(`/api/vendors?page=${page}&limit=100`);
    const data = await res.json();

    allVendors = [...allVendors, ...data.data];
    hasMore = data.pagination.hasNextPage;
    page++;
  }

  return allVendors;
}
```

### 3. Rate Limit Handling

```typescript
async function retryWithBackoff(fn, maxRetries = 3) {
  for (let attempt = 0; attempt < maxRetries; attempt++) {
    try {
      return await fn();
    } catch (error: any) {
      if (error.status === 429) {
        const retryAfter = parseInt(
          error.headers['retry-after'] || Math.pow(2, attempt) * 1000
        );
        await new Promise(resolve => setTimeout(resolve, retryAfter));
        continue;
      }
      throw error;
    }
  }
}
```

### 4. Caching Responses

```typescript
const cache = new Map();
const CACHE_TTL = 5 * 60 * 1000; // 5 minutes

async function getCachedVendors(id: string) {
  const cacheKey = `vendor_${id}`;
  const cached = cache.get(cacheKey);

  if (cached && Date.now() - cached.time < CACHE_TTL) {
    return cached.data;
  }

  const data = await fetch(`/api/vendors/${id}`);
  cache.set(cacheKey, { data, time: Date.now() });
  return data;
}
```

---

## Debugging Tips

### Enable detailed logging

```typescript
// In your API client
const response = await fetch(url, {
  ...options,
  // Log request
});

console.log('Status:', response.status);
console.log('Headers:', Object.fromEntries(response.headers));
console.log('Body:', await response.text());
```

### Use browser DevTools

1. Open DevTools (F12)
2. Go to Network tab
3. Make API request
4. Click request to inspect
5. Check: Headers, Preview, Response

### Test with cURL

```bash
# Test authentication
curl -H "Authorization: Bearer $TOKEN" https://api.aicoderally.com/v1/vendors

# Send JSON data
curl -X POST https://api.aicoderally.com/v1/pit-wall/comments \
  -H "Content-Type: application/json" \
  -d '{"body":"Great work!"}'

# Check response headers
curl -i https://api.aicoderally.com/v1/vendors
```

### Postman Collection

**Coming soon:** Import official collection with pre-configured endpoints, variables, and auth.

**For now:**
1. Create collection manually
2. Use environment variables for base URL
3. Set Authorization header with token

---

## Migration Guides

### From Direct API Calls to SDK

**Before:**
```typescript
const res = await fetch('/api/vendors', {
  headers: { 'Authorization': `Bearer ${token}` }
});
const vendors = await res.json();
```

**After:**
```typescript
import { RallyClient } from '@rally/sdk';
const client = new RallyClient({ apiKey: token });
const vendors = await client.vendors.list();
```

### Updating from v1.0 to v2.0 (When released)

- Deprecated endpoints removed
- New endpoints added
- Response formats may change
- Migration guide provided

---

## Performance Optimization

### 1. Use GraphQL-like field selection

```
GET /api/vendors/123?fields=name,rating,category
```

### 2. Implement caching headers

```
Cache-Control: max-age=300, public
ETag: "vendor_123_v2"
```

### 3. Use compression

```bash
curl -H "Accept-Encoding: gzip" /api/vendors
```

### 4. Batch requests (if available)

```typescript
POST /api/batch
{
  "requests": [
    { "method": "GET", "path": "/vendors/1" },
    { "method": "GET", "path": "/vendors/2" }
  ]
}
```
